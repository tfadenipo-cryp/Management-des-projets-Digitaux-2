stages:
  - check
  - lint
  - typecheck
  - audit
  - test


check-python:
  stage: check
  script:
    - echo "=== WHERE PYTHON ==="
    - where python
    - echo "=== VERSION ==="
    - python --version



# Lint
lint:
  stage: lint
  before_script:
    - python --version
    - python -m pip install -U uv
    - python -m uv sync --frozen
  script:
    - python -m uv run ruff check . --fix
    - python -m uv run ruff check .

# Type checking
typecheck:
  stage: typecheck
  before_script:
    - python -m pip install -U uv
    - python -m uv sync --frozen
  script:
    - python -m uv run mypy src --ignore-missing-imports

# Tests unitaires
pytest:
  stage: test
  variables:
    # Mets "src" si tes imports sont du style "from trustagence import ...",
    # sinon garde "src/trustagence" si c'est vraiment nécessaire.
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  before_script:
    - python -m pip install -U uv
    - python -m uv sync --frozen
    # (optionnel) au cas où pytest n'est pas dans [tool.uv] dev-dependencies
    - python -m uv run python -m pip install -U pytest
  script:
    - python -m uv run pytest tests/ --maxfail=1 --disable-warnings -v

# Audit de sécurité (sans requirements.txt)
security-audit:
  stage: audit
  before_script:
    - python -m pip install -U uv
    - python -m uv sync --frozen
    - python -m uv run python -m pip install -U pip-audit
  script:
    - python -m uv run pip-audit
