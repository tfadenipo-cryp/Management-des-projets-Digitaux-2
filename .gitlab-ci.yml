stages:
  - lint
  - typecheck
  - audit
  - test

# Variables communes
variables:
  PYTHONUTF8: "1"

# --- Lint ---
lint:
  stage: lint
  before_script:
    - py -3.13 -V
    - py -3.13 -m pip install -U uv
    - py -3.13 -m uv sync --frozen
  script:
    # 1. Corrige les erreurs simples
    - py -3.13 -m uv run ruff check . --fix
    # 2. Vérifie qu'il n'en reste aucune
    - py -3.13 -m uv run ruff check .

# --- Type checking ---
typecheck:
  stage: typecheck
  before_script:
    - py -3.13 -V
    - py -3.13 -m pip install -U uv
    - py -3.13 -m uv sync --frozen
  script:
    - py -3.13 -m uv run mypy src --ignore-missing-imports

# --- Tests unitaires ---
pytest:
  stage: test
  variables:
    PYTHONPATH: "$CI_PROJECT_DIR/src"
  before_script:
    - py -3.13 -V
    - py -3.13 -m pip install -U uv
    - py -3.13 -m uv sync --frozen
    - py -3.13 -m uv run python -m pip install -U pytest
  script:
    - py -3.13 -m uv run pytest tests/ --maxfail=1 --disable-warnings -v

# --- Audit de sécurité ---
security-audit:
  stage: audit
  before_script:
    - py -3.13 -V
    - py -3.13 -m pip install -U uv pip-audit
    - py -3.13 -m uv sync --frozen
  script:
    # Audit direct sur l'environnement virtuel géré par uv
    - py -3.13 -m uv run pip-audit
