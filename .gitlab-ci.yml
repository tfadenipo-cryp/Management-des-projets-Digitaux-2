# Utilisation de l'image Python comme base par défaut
image: python:3.13-slim

stages:
  - setup
  - lint
  - typecheck
  - audit
  - test

# ======================================================================
# SETUP (Installe les dépendances et crée un artefact réutilisable)
# ======================================================================
setup:
  stage: setup
  script:
    # On doit forcer l'installation dans l'environnement Docker
    - pip install uv pip-audit
    - uv sync --frozen
  artifacts:
    # Sauvegarde le dossier .venv et le lockfile pour les autres jobs
    paths:
      - .venv/
      - uv.lock
    expire_in: 1 hour

# ======================================================================
# LINTING (Ruff)
# ======================================================================
lint:
  stage: lint
  dependencies:
    - setup # Récupère l'artefact .venv
  script:
    # Exécute Ruff Check (vous devez d'abord l'exécuter localement avec --fix)
    - uv run ruff check src/ --diff --exit-code

# ======================================================================
# TYPE CHECKING (Mypy)
# ======================================================================
typecheck:
  stage: typecheck
  dependencies:
    - setup
  script:
    - uv run mypy src/ --ignore-missing-imports

# ======================================================================
# SECURITY AUDIT (pip-audit)
# ======================================================================
security-audit:
  stage: audit
  dependencies:
    - setup
  script:
    - pip-audit

# ======================================================================
# UNIT TESTS (Pytest)
# ======================================================================
pytest:
  stage: test
  dependencies:
    - setup
  script:
    - uv run pytest tests/