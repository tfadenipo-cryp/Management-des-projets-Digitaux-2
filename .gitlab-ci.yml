# Utilisation de l'image Python comme base par défaut
image: python:3.13-slim

stages:
  - setup
  - lint
  - typecheck
  - audit
  - test

# ======================================================================
# SETUP (Job pour garantir l'installation avant les autres)
# ======================================================================
setup:
  stage: setup
  script:
    - pip install uv pip-audit
    - uv sync --frozen
  artifacts:
    # Sauvegarde l'environnement virtuel pour le réutiliser dans les autres jobs (gain de temps)
    paths:
      - .venv/
      - uv.lock
    expire_in: 1 hour

# ======================================================================
# LINTING (Ruff)
# ======================================================================
lint:
  stage: lint
  dependencies:
    - setup # Dépend du job setup
  script:
    - uv run ruff check src/ --diff --exit-code

# ======================================================================
# TYPE CHECKING (Mypy)
# ======================================================================
typecheck:
  stage: typecheck
  dependencies:
    - setup
  script:
    - uv run mypy src/ --ignore-missing-imports

# ======================================================================
# SECURITY AUDIT (pip-audit)
# ======================================================================
security-audit:
  stage: audit
  dependencies:
    - setup
  script:
    - pip-audit

# ======================================================================
# UNIT TESTS (Pytest)
# ======================================================================
pytest:
  stage: test
  dependencies:
    - setup
  script:
    - uv run pytest tests/