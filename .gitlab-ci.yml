# Utilisation de l'image Python comme base par défaut
image: python:3.13-slim

stages:
  - setup
  - lint
  - typecheck
  - audit
  - test

# ======================================================================
# SETUP (Installe les dépendances via python -m pip)
# ======================================================================
setup:
  stage: setup
  script:
    # Utilisation de 'python -m pip' pour contourner le problème de PATH/PowerShell.
    - python -m pip install uv pip-audit
    - python -m uv sync --frozen
  artifacts:
    # Sauvegarde le dossier .venv et le lockfile pour les autres jobs
    paths:
      - .venv/
      - uv.lock
    expire_in: 1 hour

# ======================================================================
# LINTING (Ruff)
# ======================================================================
lint:
  stage: lint
  dependencies:
    - setup
  script:
    - python -m uv run ruff check src/ --diff --exit-code

# ======================================================================
# TYPE CHECKING (Mypy)
# ======================================================================
typecheck:
  stage: typecheck
  dependencies:
    - setup
  script:
    - python -m uv run mypy src/ --ignore-missing-imports

# ======================================================================
# SECURITY AUDIT (pip-audit)
# ======================================================================
security-audit:
  stage: audit
  dependencies:
    - setup
  script:
    - python -m pip-audit

# ======================================================================
# UNIT TESTS (Pytest)
# ======================================================================
pytest:
  stage: test
  dependencies:
    - setup
  script:
    - python -m uv run pytest tests/